<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROSIÂõæÁâáÊµèËßàÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .filters {
            max-width: 1200px;
            margin: 0 auto;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
            color: #333;
        }

        .year-slider-container {
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
        }

        .year-slider {
            display: inline-flex;
            gap: 10px;
            padding: 0 10px;
        }

        .year-btn {
            padding: 8px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            white-space: nowrap;
        }

        .year-btn:hover {
            border-color: #1890ff;
        }

        .year-btn.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .sort-buttons {
            display: flex;
            gap: 10px;
        }

        .sort-btn {
            padding: 8px 24px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .sort-btn:hover {
            border-color: #1890ff;
        }

        .sort-btn.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .proxy-selector {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            font-size: 12px;
        }

        .proxy-selector select {
            margin-left: 10px;
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .gallery {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .gallery-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .gallery-item img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            display: block;
        }

        .gallery-item-info {
            padding: 12px;
        }

        .gallery-item-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .gallery-item-stats {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
        }

        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
        }

        .modal-nav.prev {
            left: 20px;
        }

        .modal-nav.next {
            right: 20px;
        }

        .modal-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .modal-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
        }

        .load-more {
            text-align: center;
            padding: 20px;
        }

        .load-more-btn {
            padding: 10px 30px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .load-more-btn:hover {
            background: #40a9ff;
        }

        .load-more-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="filters">
        <div class="filter-section">
            <label class="filter-label">Êó∂Èó¥Á≠õÈÄâ</label>
            <div class="year-slider-container">
                <div class="year-slider" id="yearSlider"></div>
            </div>
        </div>
        <div class="filter-section">
            <label class="filter-label">ÊéíÂ∫èÊñπÂºè</label>
            <div class="sort-buttons">
                <button class="sort-btn" data-sort="sortrank">ÊúÄÊñ∞</button>
                <button class="sort-btn" data-sort="click">ÁÉ≠Ê¶ú</button>
                <button class="sort-btn" data-sort="stow">‰π¶Á≠æÊ¶ú</button>
            </div>
        </div>

    </div>
</div>

<div id="errorMessage"></div>
<div class="gallery" id="gallery"></div>

<div class="load-more">
    <button class="load-more-btn" id="loadMoreBtn">Âä†ËΩΩÊõ¥Â§ö</button>
</div>

<div class="modal" id="modal">
    <button class="modal-close" id="modalClose">√ó</button>
    <button class="modal-nav prev" id="modalPrev">‚Äπ</button>
    <button class="modal-nav next" id="modalNext">‚Ä∫</button>
    <div class="modal-content">
        <div class="image-loading" id="imageLoading">Âä†ËΩΩ‰∏≠...</div>
        <img class="modal-image" id="modalImage" src="" alt="" style="display: none;">
        <div class="modal-info" id="modalInfo"></div>
    </div>
</div>

<script>
    const API_BASE = 'https://rosi.jinyemimi.com/api_beta2_2/api.php';
    const TOKEN = 'bbe1609958bdd8d9dcb651e02cb65de4';
    const TYPEID = '1';

    let currentPage = 1;
    let currentYear = 2025;
    let currentSort = 'sortrank';
    let isLoading = false;
    let hasMore = true;
    let proxyPrefix = 'https://api.allorigins.win/raw?url=';

    // ÂΩìÂâçÊü•ÁúãÁöÑÂõæÁâá‰ø°ÊÅØ
    let currentViewingItem = null;
    let currentImageIndex = 1;
    let maxImageIndex = 1;


    // ÂàùÂßãÂåñÂπ¥‰ªΩÊªëÂùó
    function initYearSlider() {
        const yearSlider = document.getElementById('yearSlider');
        for (let year = 2025; year >= 2011; year--) {
            const btn = document.createElement('button');
            btn.className = 'year-btn';
            btn.textContent = year + 'Âπ¥';
            btn.dataset.year = year;
            if (year === 2025) btn.classList.add('active');
            btn.addEventListener('click', () => selectYear(year));
            yearSlider.appendChild(btn);
        }
    }

    // ÈÄâÊã©Âπ¥‰ªΩ
    function selectYear(year) {
        currentYear = year;
        currentPage = 1;
        hasMore = true;
        document.querySelectorAll('.year-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.year) === year);
        });
        document.getElementById('gallery').innerHTML = '';
        document.getElementById('errorMessage').innerHTML = '';
        loadImages();
    }

    // ÂàùÂßãÂåñÊéíÂ∫èÊåâÈíÆ
    function initSortButtons() {
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentSort = btn.dataset.sort;
                currentPage = 1;
                hasMore = true;
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('gallery').innerHTML = '';
                document.getElementById('errorMessage').innerHTML = '';
                loadImages();
            });
        });
        document.querySelector('.sort-btn[data-sort="sortrank"]').classList.add('active');
    }

    // Ëé∑ÂèñÂπ¥‰ªΩÊó∂Èó¥Êà≥
    function getYearTimestamps(year) {
        const staTime = Math.floor(new Date(year, 0, 1, 0, 0, 0).getTime() / 1000);
        const endTime = Math.floor(new Date(year, 11, 31, 23, 59, 59).getTime() / 1000);
        return {staTime, endTime};
    }

    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
    }

    // 1. Âà†Èô§‰ª£ÁêÜÈÄâÊã©Âô®ÈÉ®ÂàÜÔºà‰∏çÂÜçÈúÄË¶ÅÔºâ
    // Âà†Èô§ËøôÊÆµ HTML:
    /*
    <div class="proxy-selector">
      ...
    </div>
    */

    // 2. ‰øÆÊîπ loadImages ÂáΩÊï∞
    async function loadImages() {
        if (isLoading || !hasMore) return;
        isLoading = true;
        document.getElementById('loadMoreBtn').disabled = true;
        document.getElementById('loadMoreBtn').textContent = 'Âä†ËΩΩ‰∏≠...';

        try {
            const {staTime, endTime} = getYearTimestamps(currentYear);
            const apiUrl = `${API_BASE}?controller=shequ&action=queryArchiveList&page=${currentPage}&token=${TOKEN}&sta_time=${staTime}&end_time=${endTime}&typeid=${TYPEID}&orderby=${currentSort}`;

            // ‰ΩøÁî® Vercel ‰ª£ÁêÜ
            const proxyUrl = `/api/proxy?url=${encodeURIComponent(apiUrl)}`;

            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTPÈîôËØØ: ${response.status}`);
            }

            const data = await response.json();

            if (data.error && data.error.state === 0 && data.entries_s && data.entries_s.length > 0) {
                renderGallery(data.entries_s);
                currentPage++;
                hasMore = currentPage <= data.total_page;
                document.getElementById('errorMessage').innerHTML = '';
            } else {
                hasMore = false;
                if (currentPage === 1) {
                    showError('Ê≤°ÊúâÊâæÂà∞ÂõæÁâáÊï∞ÊçÆ');
                }
            }
        } catch (error) {
            console.error('Âä†ËΩΩÂ§±Ë¥•:', error);
            showError(`Âä†ËΩΩÂ§±Ë¥•: ${error.message}`);
            hasMore = false;
        } finally {
            isLoading = false;
            document.getElementById('loadMoreBtn').disabled = !hasMore;
            document.getElementById('loadMoreBtn').textContent = hasMore ? 'Âä†ËΩΩÊõ¥Â§ö' : 'Ê≤°ÊúâÊõ¥Â§ö‰∫Ü';
        }
    }

    // 3. ‰øÆÊîπ renderGallery ÂáΩÊï∞‰∏≠ÁöÑÂõæÁâá URL
    function renderGallery(items) {
        const gallery = document.getElementById('gallery');
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'gallery-item';

            // ‰ΩøÁî®ÂõæÁâá‰ª£ÁêÜ
            const imgUrl = `/api/image-proxy?url=${encodeURIComponent(item.litpic)}`;

            div.innerHTML = `
      <img src="${imgUrl}" alt="${item.title}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22250%22 height=%22300%22%3E%3Crect fill=%22%23ddd%22 width=%22250%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2214%22%3EÂõæÁâáÂä†ËΩΩÂ§±Ë¥•%3C/text%3E%3C/svg%3E'">
      <div class="gallery-item-info">
        <div class="gallery-item-title">${item.title}</div>
        <div class="gallery-item-stats">
          <span>üëÅ ${item.click}</span>
          <span>üìö ${item.stow}</span>
        </div>
      </div>
    `;
            div.addEventListener('click', () => openModal(item));
            gallery.appendChild(div);
        });
    }

    // 4. ‰øÆÊîπ openModal ÂáΩÊï∞
    async function openModal(item) {
        currentViewingItem = item;
        currentImageIndex = 1;
        maxImageIndex = 1;

        try {
            const postData = JSON.stringify({
                controller: 'archives',
                action: 'getArchiveD',
                aid: item.id,
                token: TOKEN
            });

            // ‰ΩøÁî® Vercel ‰ª£ÁêÜ
            const response = await fetch('/api/proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: API_BASE,
                    data: postData
                })
            });

            const data = await response.json();
            if (data.error && data.error.state === 0) {
                currentViewingItem = {...item, ...data};
            }
        } catch (error) {
            console.error('Ëé∑ÂèñËØ¶ÊÉÖÂ§±Ë¥•:', error);
        }

        document.getElementById('modal').classList.add('active');
        loadModalImage();
    }

    // 5. ‰øÆÊîπ loadModalImage ÂáΩÊï∞
    function loadModalImage() {
        if (!currentViewingItem || !currentViewingItem.shorttitle) {
            console.error('Áº∫Â∞ë shorttitle Â≠óÊÆµ');
            alert('ÂõæÁâá‰ø°ÊÅØ‰∏çÂÆåÊï¥');
            closeModal();
            return;
        }

        const imageNum = String(currentImageIndex).padStart(3, '0');
        const imageUrl = `http://rs.jinyemimi.com/jpg/${currentViewingItem.shorttitle}/${imageNum}.rosi`;

        // ‰ΩøÁî®ÂõæÁâá‰ª£ÁêÜ
        const proxiedUrl = `/api/image-proxy?url=${encodeURIComponent(imageUrl)}`;

        const modalImage = document.getElementById('modalImage');
        const imageLoading = document.getElementById('imageLoading');

        modalImage.style.display = 'none';
        imageLoading.style.display = 'block';

        document.getElementById('modalPrev').disabled = currentImageIndex <= 1;

        modalImage.onload = function () {
            imageLoading.style.display = 'none';
            modalImage.style.display = 'block';
            maxImageIndex = Math.max(maxImageIndex, currentImageIndex);
        };

        modalImage.onerror = function () {
            imageLoading.style.display = 'none';
            if (currentImageIndex > maxImageIndex) {
                alert('Â∑≤ÁªèÊòØÊúÄÂêé‰∏ÄÂº†ÂõæÁâá‰∫Ü');
                currentImageIndex = maxImageIndex;
                loadModalImage();
            } else {
                modalImage.style.display = 'block';
                modalImage.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22600%22%3E%3Crect fill=%22%23333%22 width=%22800%22 height=%22600%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23fff%22 font-size=%2224%22%3EÂõæÁâáÂä†ËΩΩÂ§±Ë¥•%3C/text%3E%3C/svg%3E';
            }
        };

        modalImage.src = proxiedUrl;
        document.getElementById('modalInfo').textContent =
            `${currentViewingItem.title} - Á¨¨ ${currentImageIndex} Âº†`;

        // È¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÂº†
        setTimeout(() => {
            const nextImageNum = String(currentImageIndex + 1).padStart(3, '0');
            const nextImageUrl = `http://rs.jinyemimi.com/jpg/${currentViewingItem.shorttitle}/${nextImageNum}.rosi`;
            const nextProxiedUrl = `/api/image-proxy?url=${encodeURIComponent(nextImageUrl)}`;
            const preloadImg = new Image();
            preloadImg.src = nextProxiedUrl;
        }, 1000);
    }


    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    function closeModal() {
        document.getElementById('modal').classList.remove('active');
        currentViewingItem = null;
        currentImageIndex = 1;
        maxImageIndex = 1;
    }

    // ‰∏ä‰∏ÄÂº†ÂõæÁâá
    function prevImage() {
        if (currentImageIndex > 1) {
            currentImageIndex--;
            loadModalImage();
        }
    }

    // ‰∏ã‰∏ÄÂº†ÂõæÁâá
    function nextImage() {
        currentImageIndex++;
        loadModalImage();
    }

    // ‰∫ã‰ª∂ÁõëÂê¨
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalPrev').addEventListener('click', prevImage);
    document.getElementById('modalNext').addEventListener('click', nextImage);
    document.getElementById('loadMoreBtn').addEventListener('click', loadImages);

    // ÈîÆÁõòÂØºËà™
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('modal').classList.contains('active')) {
            if (e.key === 'Escape') closeModal();
            if (e.key === 'ArrowLeft') prevImage();
            if (e.key === 'ArrowRight') nextImage();
        }
    });

    // Ëß¶Êë∏ÊªëÂä®ÊîØÊåÅ
    let touchStartX = 0;
    let touchEndX = 0;

    document.getElementById('modal').addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.getElementById('modal').addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        if (touchEndX < touchStartX - 50) nextImage();
        if (touchEndX > touchStartX + 50) prevImage();
    }

    // ÂàùÂßãÂåñ
    initYearSlider();
    initSortButtons();
    loadImages();
</script>
</body>
</html>
